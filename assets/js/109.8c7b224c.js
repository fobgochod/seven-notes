(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{504:function(t,e,a){"use strict";a.r(e);var s=a(4),r=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"jvm"}},[t._v("JVM")]),t._v(" "),e("h3",{attrs:{id:"java-19-virtual-threads"}},[t._v("Java 19 Virtual Threads")]),t._v(" "),e("blockquote",[e("p",[e("a",{attrs:{href:"https://www.youtube.com/playlist?list=PLX8CzqL3ArzV4BpOzLanxd4bZr46x5e87",target:"_blank",rel:"noopener noreferrer"}},[t._v("JEP Café"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("A Java Thread, as created in the very early versions of Java is a thin wrapper on a platform thread. also called\noperating system thread. There are two things you need to know about them.")]),t._v(" "),e("ul",[e("li",[t._v("First, a platform thread needs to store its call stack in memory. For that, 20MB are reserved upfront in memory.")]),t._v(" "),e("li",[t._v("Second, it is a system resource. It takes abouts 1ms to launch a platform thread.\nSo: "),e("strong",[t._v("20MB of memory, 1ms to launch")]),t._v(".")])]),t._v(" "),e("p",[t._v("A platform thread is in fact a rather expensive resource. How can you optimize hardware utilization with such threads?")]),t._v(" "),e("p",[t._v("Suppose you have 16GB of memory available for your application. Divided by 20MB for a thread, you have room for 800\nthreads on such a machine. Suppose these threads are doing some I/O like accessing resources on a network. And suppose\nthat this resource is accessed in 100ms. Preparing the request and processing the response will be done in the order of\n10 nanoseconds. Suppose all this in-memory computations are taking 1000 nanoseconds. It means that there is a factor in\nthe order of "),e("strong",[t._v("100 thousand")]),t._v(" between the preparation of the request and the processing of the response, and the time it\ntakes to get the response. During which your thread is sitting there, doing noting.")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Request preparation")]),t._v(" "),e("th",[t._v("Network access")]),t._v(" "),e("th",[t._v("Response Processing")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("500ns")]),t._v(" "),e("td",[t._v("100ms")]),t._v(" "),e("td",[t._v("500ns")])])])]),t._v(" "),e("p",[t._v("So if you have 800 such threads you CPU will be used at 0.8%. Less than 1%. And if double the memory to 32GB, it will be\nused at 1.3%. Which is still pretty low. If you want a CPU usage of 90%, then you need 90k such threads.\nLaunching them will take 90s, that is 1 minute and a half, and they will consume 1.8TB of memory.")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("memory(GB)")]),t._v(" "),e("th",[t._v("threads")]),t._v(" "),e("th",[t._v("launch(s)")]),t._v(" "),e("th",[t._v("CPU usage(%s)")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("16")]),t._v(" "),e("td",[t._v("800")]),t._v(" "),e("td",[t._v("0.8")]),t._v(" "),e("td",[t._v("0.8")])]),t._v(" "),e("tr",[e("td",[t._v("32")]),t._v(" "),e("td",[t._v("1600")]),t._v(" "),e("td",[t._v("1.6")]),t._v(" "),e("td",[t._v("1.3")])]),t._v(" "),e("tr",[e("td",[t._v("1800")]),t._v(" "),e("td",[t._v("90000")]),t._v(" "),e("td",[t._v("90")]),t._v(" "),e("td",[t._v("90")])])])]),t._v(" "),e("p",[t._v('So clearly, platform threads are far too expensive to "scale with near-optimal hardware utilization."\nAnother model of thread is needed there, this first gaol is very ambitious.\nThe second goal is to enable the existing code built in the classical Java Threads to adopt Virtual Threads with minimal\nchanges. This goal is also very ambitious, because it means that everything you could do with classical Threads,\nyou should be able to do it in the same way with Virtual Threads.')]),t._v(" "),e("p",[t._v("That covers several key points:")]),t._v(" "),e("ul",[e("li",[t._v("First, virtual thread can run any Java code ot any native code.")]),t._v(" "),e("li",[t._v("Second, you do not need to learn any new concepts")]),t._v(" "),e("li",[t._v("Third, but you need to unlearn certain ideas. And here are some of them.\n"),e("ul",[e("li",[t._v("First: virtual threads are cheap, about 1000 times cheaper than classical platform thread.")]),t._v(" "),e("li",[t._v("Second: blocking a virtual thread is also cheap, so trying to avoid blocking a virtual thread is useless.")]),t._v(" "),e("li",[t._v("Writing classical blocking code is OK. And that's a good news, because blocking code is so much easier to write\nthan asynchronous code.")])])])]),t._v(" "),e("p",[t._v("At this point, you may wonder: is it a good idea to pool virtual threads? Well... the answer is... no, don't do that,\nyou are just wasting your time. Dose it make executor services useless? Well, yes and no. Usually executor services are\nused to control the number of platform threads used by your application. So this use case is clearly useless now. You\ndon't need to do that with virtual threads. But it's not always the case,\nit can also be a convenient way to create threads.")]),t._v(" "),e("h3",{attrs:{id:"selecting-a-collector-option"}},[t._v("Selecting a Collector Option")]),t._v(" "),e("blockquote",[e("p",[e("a",{attrs:{href:"https://hllvm-group.iteye.com/group/topic/37095",target:"_blank",rel:"noopener noreferrer"}},[t._v("ParNew 和 PSYoungGen 和 DefNew 是一个东西么？"),e("OutboundLink")],1)])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Options")]),t._v(" "),e("th",[t._v("Young/Tenured Generation")]),t._v(" "),e("th",[t._v("Threads")]),t._v(" "),e("th",[t._v("GC日志")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("-XX:+UseSerialGC")]),t._v(" "),e("td"),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("Copy/Serial")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("DefNew")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("MSC(MarkSweepCompact)/Serial Old")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("Tenured")])]),t._v(" "),e("tr",[e("td",[t._v("-XX:+UseParNewGC")]),t._v(" "),e("td"),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("ParNew")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("ParNew")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("MSC(MarkSweepCompact)/Serial Old")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("Tenured")])]),t._v(" "),e("tr",[e("td",[t._v("-XX:+UseParallelGC")]),t._v(" "),e("td"),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("PS Scavenge")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("PSYoungGen")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("PS MarkSweep/ParallelOld(JDK7u4之后)")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("ParOldGen")])]),t._v(" "),e("tr",[e("td",[t._v("-XX:+UseConcMarkSweepGC")]),t._v(" "),e("td"),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("ParNew")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("ParNew")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("CMS(ConcurrentMarkSweep)")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("CMS Initial Mark")])]),t._v(" "),e("tr",[e("td",[t._v("-XX:+UseG1GC")]),t._v(" "),e("td"),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("G1 Young Generation")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("G1 Evacuation Pause")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("G1 Old Generation")]),t._v(" "),e("td",[t._v("10")]),t._v(" "),e("td",[t._v("Metadata GC Threshold")])])])]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# G1")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-XX:ParallelGCThreads")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" + "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n - "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" * "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("/8"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-XX:ConcGCThreads")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-XX:ParallelGCThreads")]),t._v(" / "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Parallel")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-XX:ParallelGCThreads")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" + "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n - "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" * "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("/8"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h3",{attrs:{id:"jps、jinfo、jstack、jmap、jstat"}},[t._v("jps、jinfo、jstack、jmap、jstat")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 列出java进程")]),t._v("\njsp "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-l")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 系统属性和jvm运行参数")]),t._v("\njinfo pid\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 所有线程堆栈")]),t._v("\njstack pid\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 堆内存信息")]),t._v("\njmap "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-heap")]),t._v(" pid\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 特定类的堆统计")]),t._v("\njmap "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-histo")]),t._v(" pid\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# jvm统计信息")]),t._v("\njstat "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-gc")]),t._v(" pid "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\njstat "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-gcutil")]),t._v(" pid "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\njstat "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-gcnew")]),t._v(" pid "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br")])]),e("h3",{attrs:{id:"cms垃圾回收的碎片解决方式"}},[t._v("CMS垃圾回收的碎片解决方式")]),t._v(" "),e("h3",{attrs:{id:"jvm垃圾回收器cms的优缺点、与g1的区别、进入老年代的时机"}},[t._v("JVM垃圾回收器CMS的优缺点、与G1的区别、进入老年代的时机")]),t._v(" "),e("h3",{attrs:{id:"cms与g1对比较"}},[t._v("CMS与G1对比较")]),t._v(" "),e("ul",[e("li",[t._v("由于CMS默认启动线程(核心+3)/4 当服务器核心低于4个时候，垃圾收集占比较高，用户线程影响较大")]),t._v(" "),e("li",[t._v("无法处理浮动垃圾，所以不能等内存用满再回收，JDK5(68%)->JDK(92%)")]),t._v(" "),e("li",[t._v("采用标记-清除算法，必然带来内存碎片，通过参数开启full gc时候进行内存整理")])]),t._v(" "),e("h3",{attrs:{id:"常用的垃圾回收器"}},[t._v("常用的垃圾回收器")]),t._v(" "),e("ul",[e("li",[t._v("串行(Serial)：复制算法的Serial、Serial Old(MSC)")]),t._v(" "),e("li",[t._v("并行(Parallel): ParNew、PS Scavenge、PS MarkSweep")]),t._v(" "),e("li",[t._v("大多数并发：CMS、G1")]),t._v(" "),e("li",[t._v("并发：ZGC、Shenandoah")])]),t._v(" "),e("h3",{attrs:{id:"jvm内存模型"}},[t._v("JVM内存模型")]),t._v(" "),e("ul",[e("li",[t._v("公共区域：方法区、堆Heap")]),t._v(" "),e("li",[t._v("线程私有：程序计数器、虚拟机栈(VM Stack)、本地方法栈")])]),t._v(" "),e("h3",{attrs:{id:"jvm调优思路"}},[t._v("JVM调优思路")]),t._v(" "),e("ul",[e("li",[t._v("串行、并行、并发")]),t._v(" "),e("li",[t._v("吞吐量、延时")])]),t._v(" "),e("h3",{attrs:{id:"偏向锁、轻量级锁、重量级锁底层原理、升级过程"}},[t._v("偏向锁、轻量级锁、重量级锁底层原理、升级过程")]),t._v(" "),e("h3",{attrs:{id:"gc-root、moduniontable"}},[t._v("GC Root、ModUnionTable")]),t._v(" "),e("h2",{attrs:{id:"reference"}},[t._v("Reference")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java 8 Command"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java 8 HotSpot Virtual Machine Garbage Collection Tuning Guide"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java 17 Command"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.oracle.com/en/java/javase/17/gctuning/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java 17 HotSpot Virtual Machine Garbage Collection Tuning Guide"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=r.exports}}]);